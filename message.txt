DROP TABLE IF EXISTS zgloszenie; 
DROP TABLE IF EXISTS wiadomosc;
DROP TABLE IF EXISTS rezerwacja_ksiazki;
DROP TABLE IF EXISTS wypozyczenie;
DROP TABLE IF EXISTS ksiazka;
DROP TABLE IF EXISTS zajecie_w_planie;
DROP TABLE IF EXISTS plan_zajec;
DROP TABLE IF EXISTS material_dydaktyczny;
DROP TABLE IF EXISTS platnosc;
DROP TABLE IF EXISTS faktura;
DROP TABLE IF EXISTS konto_studenta;
DROP TABLE IF EXISTS ocena_czastkowa;
DROP TABLE IF EXISTS ocena_koncowa;
DROP TABLE IF EXISTS zapis_na_przedmiot;
DROP TABLE IF EXISTS grupa_zajeciowa;
DROP TABLE IF EXISTS przedmiot;
DROP TABLE IF EXISTS kategoria_przedmiotu;
DROP TABLE IF EXISTS semestr;
DROP TABLE IF EXISTS kierunek;
DROP TABLE IF EXISTS student;
DROP TABLE IF EXISTS prowadzacy;
DROP TABLE IF EXISTS uzytkownik;

CREATE TABLE uzytkownik (
    uzytkownik_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    login VARCHAR(50) UNIQUE NOT NULL,
    haslo_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    rola VARCHAR(20) NOT NULL CHECK (rola IN ('student', 'prowadzacy', 'admin', 'bibliotekarz', 'ksiegowy')),
    aktywny BOOLEAN DEFAULT TRUE,
    data_rejestracji TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ostatnie_logowanie TIMESTAMP,
    liczba_nieudanych_logowan INT DEFAULT 0
);

CREATE TABLE student (
    student_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    uzytkownik_id INT UNIQUE NOT NULL,
    numer_albumu VARCHAR(20) UNIQUE NOT NULL,
    imie VARCHAR(50) NOT NULL,
    nazwisko VARCHAR(50) NOT NULL,
    pesel VARCHAR(11),
    data_urodzenia DATE,
    plec CHAR(1) CHECK (plec IN ('M', 'K')),
    adres VARCHAR(200),
    telefon VARCHAR(20),
    email_uczelniany VARCHAR(100),
    kierunek_id INT NOT NULL,
    rok_rozpoczecia INT NOT NULL,
    FOREIGN KEY (uzytkownik_id) REFERENCES uzytkownik(uzytkownik_id) ON DELETE CASCADE
);

CREATE TABLE prowadzacy (
    prowadzacy_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    uzytkownik_id INT UNIQUE NOT NULL,
    tytul_naukowy VARCHAR(50),
    imie VARCHAR(50) NOT NULL,
    nazwisko VARCHAR(50) NOT NULL,
    specjalizacja VARCHAR(100),
    email VARCHAR(100),
    telefon VARCHAR(20),
    pokoj VARCHAR(20),
    data_zatrudnienia DATE,
    FOREIGN KEY (uzytkownik_id) REFERENCES uzytkownik(uzytkownik_id) ON DELETE CASCADE
);

CREATE TABLE kierunek (
    kierunek_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nazwa VARCHAR(100) NOT NULL,
    wydzial VARCHAR(100) NOT NULL,
    stopien_studiow VARCHAR(50) CHECK (stopien_studiow IN ('licencjackie', 'inzynierskie', 'magisterskie', 'doktoranckie')),
    liczba_semestrow INT NOT NULL,
    opis TEXT
);

CREATE TABLE semestr (
    semestr_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    kierunek_id INT NOT NULL,
    numer INT NOT NULL CHECK (numer BETWEEN 1 AND 12),
    rok_akademicki INT NOT NULL,
    typ VARCHAR(20) CHECK (typ IN ('zimowy', 'letni')),
    data_rozpoczecia DATE NOT NULL,
    data_zakonczenia DATE NOT NULL,
    FOREIGN KEY (kierunek_id) REFERENCES kierunek(kierunek_id) ON DELETE CASCADE
);

CREATE TABLE kategoria_przedmiotu (
    kategoria_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nazwa VARCHAR(100) NOT NULL UNIQUE,
    opis TEXT
);

CREATE TABLE przedmiot (
    przedmiot_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    kod VARCHAR(20) UNIQUE NOT NULL,
    nazwa VARCHAR(150) NOT NULL,
    ects INT NOT NULL CHECK (ects > 0),
    opis TEXT,
    prowadzacy_id INT,
    kategoria_id INT,
    kierunek_id INT NOT NULL,
    semestr_id INT NOT NULL,
    typ_zajec VARCHAR(50) CHECK (typ_zajec IN ('wyklad', 'cwiczenia', 'laboratorium', 'projekt', 'seminarium')),
    godziny_wykladowe INT DEFAULT 0,
    godziny_cwiczeniowe INT DEFAULT 0,
    godziny_laboratoryjne INT DEFAULT 0,
    obowiazkowy BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (prowadzacy_id) REFERENCES prowadzacy(prowadzacy_id) ON DELETE SET NULL,
    FOREIGN KEY (kategoria_id) REFERENCES kategoria_przedmiotu(kategoria_id) ON DELETE SET NULL,
    FOREIGN KEY (kierunek_id) REFERENCES kierunek(kierunek_id) ON DELETE CASCADE,
    FOREIGN KEY (semestr_id) REFERENCES semestr(semestr_id) ON DELETE CASCADE
);

CREATE TABLE grupa_zajeciowa (
    grupa_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    przedmiot_id INT NOT NULL,
    kod_grupy VARCHAR(20) NOT NULL,
    prowadzacy_id INT,
    limit_miejsc INT NOT NULL CHECK (limit_miejsc > 0),
    zapisanych INT DEFAULT 0 CHECK (zapisanych <= limit_miejsc),
    typ_zajec VARCHAR(50) CHECK (typ_zajec IN ('wyklad', 'cwiczenia', 'laboratorium', 'projekt')),
    termin VARCHAR(100),
    sala VARCHAR(50),
    FOREIGN KEY (przedmiot_id) REFERENCES przedmiot(przedmiot_id) ON DELETE CASCADE,
    FOREIGN KEY (prowadzacy_id) REFERENCES prowadzacy(prowadzacy_id) ON DELETE SET NULL
);

CREATE TABLE zapis_na_przedmiot (
    zapis_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id INT NOT NULL,
    przedmiot_id INT NOT NULL,
    grupa_id INT NOT NULL,
    data_zapisu DATE DEFAULT CURRENT_DATE,
    status VARCHAR(20) DEFAULT 'zapisany' CHECK (status IN ('zapisany', 'wypisany', 'zaliczony', 'niezaliczony')),
    rok_akademicki INT NOT NULL,
    semestr INT NOT NULL CHECK (semestr BETWEEN 1 AND 2),
    UNIQUE (student_id, przedmiot_id, rok_akademicki, semestr),
    FOREIGN KEY (student_id) REFERENCES student(student_id) ON DELETE CASCADE,
    FOREIGN KEY (przedmiot_id) REFERENCES przedmiot(przedmiot_id) ON DELETE CASCADE,
    FOREIGN KEY (grupa_id) REFERENCES grupa_zajeciowa(grupa_id) ON DELETE CASCADE
);

CREATE TABLE ocena_koncowa (
    ocena_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id INT NOT NULL,
    przedmiot_id INT NOT NULL,
    ocena DECIMAL(3,2) CHECK (ocena BETWEEN 2.0 AND 5.0),
    ocena_slownie VARCHAR(20),
    data_wpisu DATE DEFAULT CURRENT_DATE,
    prowadzacy_wpisujacy INT NOT NULL,
    zaliczony BOOLEAN DEFAULT TRUE,
    UNIQUE (student_id, przedmiot_id),
    FOREIGN KEY (student_id) REFERENCES student(student_id) ON DELETE CASCADE,
    FOREIGN KEY (przedmiot_id) REFERENCES przedmiot(przedmiot_id) ON DELETE CASCADE,
    FOREIGN KEY (prowadzacy_wpisujacy) REFERENCES prowadzacy(prowadzacy_id) ON DELETE CASCADE
);

CREATE TABLE ocena_czastkowa (
    czastkowa_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ocena_id INT NOT NULL,
    nazwa VARCHAR(100) NOT NULL,
    wartosc DECIMAL(5,2) NOT NULL,
    waga DECIMAL(3,2) DEFAULT 1.0 CHECK (waga BETWEEN 0 AND 1),
    komentarz TEXT,
    data_wpisu DATE DEFAULT CURRENT_DATE,
    prowadzacy_id INT NOT NULL,
    FOREIGN KEY (ocena_id) REFERENCES ocena_koncowa(ocena_id) ON DELETE CASCADE,
    FOREIGN KEY (prowadzacy_id) REFERENCES prowadzacy(prowadzacy_id) ON DELETE CASCADE
);

CREATE TABLE konto_studenta (
    konto_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id INT UNIQUE NOT NULL,
    saldo DECIMAL(10,2) DEFAULT 0.00,
    zadluzenie DECIMAL(10,2) DEFAULT 0.00,
    data_ostatniej_aktualizacji TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES student(student_id) ON DELETE CASCADE
);

CREATE TABLE faktura (
    faktura_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    konto_id INT NOT NULL,
    numer_faktury VARCHAR(50) UNIQUE NOT NULL,
    data_wystawienia DATE NOT NULL,
    termin_platnosci DATE NOT NULL,
    kwota DECIMAL(10,2) NOT NULL CHECK (kwota > 0),
    tytul VARCHAR(200) NOT NULL,
    status VARCHAR(20) DEFAULT 'niewplata' CHECK (status IN ('niewplata', 'oplacona', 'anulowana', 'przeterminowana')),
    opis TEXT,
    FOREIGN KEY (konto_id) REFERENCES konto_studenta(konto_id) ON DELETE CASCADE
);

CREATE TABLE platnosc (
    platnosc_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    faktura_id INT NOT NULL,
    kwota DECIMAL(10,2) NOT NULL CHECK (kwota > 0),
    data_platnosci DATE DEFAULT CURRENT_DATE,
    metoda_platnosci VARCHAR(50) CHECK (metoda_platnosci IN ('przelew', 'gotowka', 'karta', 'BLIK')),
    status VARCHAR(20) DEFAULT 'zaksięgowana' CHECK (status IN ('zaksięgowana', 'anulowana', 'blad')),
    identyfikator_transakcji VARCHAR(100),
    FOREIGN KEY (faktura_id) REFERENCES faktura(faktura_id) ON DELETE CASCADE
);

CREATE TABLE material_dydaktyczny (
    material_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    przedmiot_id INT NOT NULL,
    nazwa VARCHAR(200) NOT NULL,
    typ VARCHAR(50) CHECK (typ IN ('pdf', 'doc', 'ppt', 'video', 'link', 'zip')),
    sciezka_pliku VARCHAR(500) NOT NULL,
    rozmiar INT,
    data_dodania TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    dodany_przez INT NOT NULL,
    publiczny BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (przedmiot_id) REFERENCES przedmiot(przedmiot_id) ON DELETE CASCADE,
    FOREIGN KEY (dodany_przez) REFERENCES uzytkownik(uzytkownik_id) ON DELETE CASCADE
);

CREATE TABLE plan_zajec (
    plan_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    semestr_id INT NOT NULL,
    nazwa VARCHAR(100) NOT NULL,
    data_obowiazywania_od DATE NOT NULL,
    data_obowiazywania_do DATE NOT NULL,
    FOREIGN KEY (semestr_id) REFERENCES semestr(semestr_id) ON DELETE CASCADE
);

CREATE TABLE zajecie_w_planie (
    zajecie_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    plan_id INT NOT NULL,
    grupa_id INT NOT NULL,
    dzien_tygodnia INT NOT NULL CHECK (dzien_tygodnia BETWEEN 1 AND 7),
    godzina_rozpoczecia TIME NOT NULL,
    godzina_zakonczenia TIME NOT NULL,
    sala VARCHAR(50) NOT NULL,
    budynek VARCHAR(50) NOT NULL,
    typ_zajec VARCHAR(50),
    FOREIGN KEY (plan_id) REFERENCES plan_zajec(plan_id) ON DELETE CASCADE,
    FOREIGN KEY (grupa_id) REFERENCES grupa_zajeciowa(grupa_id) ON DELETE CASCADE
);

CREATE TABLE ksiazka (
    ksiazka_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    isbn VARCHAR(20) UNIQUE,
    tytul VARCHAR(200) NOT NULL,
    autor VARCHAR(200) NOT NULL,
    wydawnictwo VARCHAR(100),
    rok_wydania INT,
    kategoria VARCHAR(100),
    sygnatura VARCHAR(50) UNIQUE NOT NULL,
    dostepna BOOLEAN DEFAULT TRUE,
    opis TEXT
);

CREATE TABLE wypozyczenie (
    wypozyczenie_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id INT NOT NULL,
    ksiazka_id INT NOT NULL,
    data_wypozyczenia DATE DEFAULT CURRENT_DATE,
    data_zwrotu DATE,
    termin_zwrotu DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'wypozyczona' CHECK (status IN ('wypozyczona', 'zwrocona', 'przetrzymana')),
    kara DECIMAL(5,2) DEFAULT 0.00,
    FOREIGN KEY (student_id) REFERENCES student(student_id) ON DELETE CASCADE,
    FOREIGN KEY (ksiazka_id) REFERENCES ksiazka(ksiazka_id) ON DELETE CASCADE
);

CREATE TABLE rezerwacja_ksiazki (
    rezerwacja_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id INT NOT NULL,
    ksiazka_id INT NOT NULL,
    data_rezerwacji DATE DEFAULT CURRENT_DATE,
    termin_odbioru DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'aktywna' CHECK (status IN ('aktywna', 'anulowana', 'wygasla', 'zrealizowana')),
    FOREIGN KEY (student_id) REFERENCES student(student_id) ON DELETE CASCADE,
    FOREIGN KEY (ksiazka_id) REFERENCES ksiazka(ksiazka_id) ON DELETE CASCADE
);

CREATE TABLE wiadomosc (
    wiadomosc_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nadawca_id INT NOT NULL,
    odbiorca_id INT NOT NULL,
    temat VARCHAR(200) NOT NULL,
    tresc TEXT NOT NULL,
    data_wyslania TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    przeczytana BOOLEAN DEFAULT FALSE,
    typ VARCHAR(20) CHECK (typ IN ('systemowa', 'prywatna', 'powiadomienie')),
    FOREIGN KEY (nadawca_id) REFERENCES uzytkownik(uzytkownik_id) ON DELETE CASCADE,
    FOREIGN KEY (odbiorca_id) REFERENCES uzytkownik(uzytkownik_id) ON DELETE CASCADE
);

CREATE TABLE zgloszenie (
    zgloszenie_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id INT NOT NULL,
    typ VARCHAR(50) CHECK (typ IN ('techniczne', 'merytoryczne', 'administracyjne', 'finansowe', 'biblioteczne')),
    temat VARCHAR(200) NOT NULL,
    opis TEXT NOT NULL,
    data_zgloszenia TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'otwarte' CHECK (status IN ('otwarte', 'w_trakcie', 'zamkniete', 'anulowane')),
    odpowiedz TEXT,
    data_odpowiedzi TIMESTAMP,
    obslugujacy_id INT,
    FOREIGN KEY (student_id) REFERENCES student(student_id) ON DELETE CASCADE,
    FOREIGN KEY (obslugujacy_id) REFERENCES uzytkownik(uzytkownik_id) ON DELETE SET NULL
);

CREATE INDEX idx_student_kierunek ON student(kierunek_id);
CREATE INDEX idx_przedmiot_semestr ON przedmiot(semestr_id);
CREATE INDEX idx_zapis_student ON zapis_na_przedmiot(student_id);
CREATE INDEX idx_zapis_przedmiot ON zapis_na_przedmiot(przedmiot_id);
CREATE INDEX idx_ocena_student ON ocena_koncowa(student_id);
CREATE INDEX idx_ocena_przedmiot ON ocena_koncowa(przedmiot_id);
CREATE INDEX idx_wypozyczenie_student ON wypozyczenie(student_id);
CREATE INDEX idx_wypozyczenie_ksiazka ON wypozyczenie(ksiazka_id);
CREATE INDEX idx_faktura_konto ON faktura(konto_id);
CREATE INDEX idx_platnosc_faktura ON platnosc(faktura_id);
CREATE INDEX idx_grupa_przedmiot ON grupa_zajeciowa(przedmiot_id);
CREATE INDEX idx_material_przedmiot ON material_dydaktyczny(przedmiot_id);
CREATE INDEX idx_zajecie_plan ON zajecie_w_planie(plan_id);
CREATE INDEX idx_zajecie_grupa ON zajecie_w_planie(grupa_id);

